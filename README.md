# ABOUT

## Результат задания "Фонарь"

- [ok] При запуске фонарь должен запрашивать хост:порт (по умолчанию
127.0.0.1:9999​ ), подсоединяться по TCP и после этого начать отрабатывать
протокол управления.

    > Для отладки был сделан тестовый стенд который эмулирует работу Сервера

- [ok] При​ получении данных от сервера фонарь собирает целые команды (type​ ​length + value) и, если type известен, обрабатывает команду, иначе молча​ ​
ее
игнорирует.


- [ok] При получении команды ON фонарь включается (отрисовку фонаря
оставляем на
ваше усмотрение).

- [ok] При получении команды OFF фонарь выключается.

- [ok] При получении команды COLOR фонарь меняет цвет.

- При завершении работы фонарь корректно закрывает соединение с
сервером.

- [ok] Реализация фонаря позволяет легко добавлять любые новые команды.

- [ok] При неожиданных разрывах связи фонарь должен пытаться восстановить
соединение.

## Docker

собран тестовый стенд в результате запускается 2 сервера (процесса)

для запуска стенда нужно ввести команду `docker-compose up --build`
открыть в браузере http://localhost:8888/

В резульатате поднимутся 2 сервера на портах:

    `8888` - HTML-websocket морда
    `9999` - Тестовый сервер фонаря
    `9000` - API-Админка тестового сервера фонара

- Server отвечает за эмуляция ф-ала сервера "фонаря", который отдает Client по TCP
  В формате TLV сообщения. Для отладки у сервера реализован json-api по
  нему можно инициировать отправку сообщения через TCP посредством отправки
  http json сообщения, например смена цвета:

  ```
  curl -d '{"method": "message", "params": {"command": "COLOR", "value": "ff0000"}}' http://localhost:9000
  ```

  что приведет к отправке клиенту сообщения `b'\x20\x00\x03\xff\x00\x00'`

  ```
  struct.unpack('>ch3s', b'\x20\x00\x03\xff\x00\x00')
  (b' ', 3, b'\xff\x00\x00')
  ```

  для удобства демонитрации работы в HTML клиенте добавлены 3 кнопки которые отправят в API нужные команды

- И так json-сообщение по http отправляется в отладочный сервер по порту 9000,
  далее TLV сообщение по TCP отправляется всем клиентам которые подсоединились к серверу по 9999 порту
  После этого TLV сообщение трансформируется в json сообщение и отправляется по websocket всем клиентам
  (в нашем случае браузерам) по 8888 порты.

  **Disclaimer:** так как в задание не указываются проблемы масштабирования для доставки сообщения используется
  скоуп питон процесса для реализации pub/sub взаимодействия. В продакте конечно стоит использовать доп. транспорт.
  Но это не мешает использовать несколько клиентов вместе.
  Для демонстрации в docker-compose добавлены допильнительные клиенты фонаря которые синхронно будут отрабатывать протокол.

- Для тестирования недоступности сервера можно запустить отдельную команду `docker-compose stop server`
  клиент с периодиченостью в 1 секунду начнет пытаться сединяться с сервером

- Для отладки нескольких WS-клиентов можно запустить несколько окон барузера.